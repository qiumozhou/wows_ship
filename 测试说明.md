# 程序测试说明

## 测试目的
验证优化后的代码能否正确识别游戏状态并点击"加入战斗"按钮。

## 测试前准备

### 1. 确认依赖已安装
```bash
pip install -r requirements.txt
```

### 2. 确认游戏设置
- 游戏分辨率：1920x1080（全屏或窗口化全屏）
- 确保游戏界面元素清晰可见
- 关闭游戏内可能遮挡按钮的弹窗

## 测试步骤

### 测试1：调试模式测试（推荐首次运行）

#### 步骤
1. 打开游戏，进入港口界面
2. 运行调试模式：
   ```bash
   python wows_auto_bot.py --debug
   ```
3. 观察控制台输出，应该看到：
   ```
   检测到港口界面（橙色加入战斗按钮）
   或
   检测到港口界面（底部战船选择栏特征）
   ```

#### 检查点
- [ ] 程序能否识别港口界面？
- [ ] 程序能否检测到橙色按钮？
- [ ] 程序是否尝试点击按钮？
- [ ] `debug_output/` 目录是否生成了截图？

#### 查看调试截图
检查以下文件：
- `state_port_*.png` - 港口界面检测截图
- `orange_button_detected_*.png` - 橙色按钮检测截图
- `after_select_ship_*.png` - 选择战船后的截图
- `after_join_battle_click_*.png` - 点击加入战斗后的截图

#### 预期结果
1. 在 `orange_button_detected_*.png` 中应该能看到：
   - 绿色矩形框标记按钮区域（右上角）
   - 红色圆点标记按钮中心

2. 控制台日志应该显示：
   ```
   检测到橙色加入战斗按钮，位置: (730, 25)
   或类似坐标
   ```

### 测试2：正常模式测试

#### 步骤
1. 确认调试模式测试通过
2. 运行正常模式：
   ```bash
   python wows_auto_bot.py
   ```
3. 让程序自动运行

#### 检查点
- [ ] 程序能否自动点击"加入战斗"按钮？
- [ ] 是否成功进入游戏加载界面？
- [ ] 是否正常进入战斗？

### 测试3：不同状态测试

#### 测试3.1：从港口界面开始
1. 确保在港口界面
2. 运行程序
3. 观察是否正确执行：选择战船 → 点击加入战斗 → 进入游戏

#### 测试3.2：从战斗中开始
1. 手动进入一局游戏
2. 在战斗进行中运行程序
3. 观察是否正确识别为"战斗中"状态

#### 测试3.3：从被击毁状态开始
1. 在被击毁后运行程序
2. 观察是否正确识别为"被击毁"状态
3. 是否自动退出并返回港口

## 常见问题排查

### 问题1：无法识别港口界面

#### 症状
日志显示：`未知状态: GameState.UNKNOWN` 或其他错误状态

#### 排查步骤
1. 查看 `debug_output/state_unknown_*.png`
2. 检查日志中的像素数：
   ```
   橙色按钮区域检测到橙色像素数: 0
   底部区域平均亮度: xxx
   ```
3. 如果橙色像素数为0：
   - 可能是游戏界面变化
   - 需要调整 `ORANGE_LOWER` 和 `ORANGE_UPPER` 参数
   - 或调整 `JOIN_BATTLE_BUTTON_REGION` 区域

#### 解决方案
打开 `wows_auto_bot.py`，调整以下参数：
```python
# 橙色范围（根据实际情况调整）
ORANGE_LOWER = np.array([10, 100, 100])
ORANGE_UPPER = np.array([25, 255, 255])

# 按钮区域（根据实际位置调整）
JOIN_BATTLE_BUTTON_REGION = (650, 0, 850, 50)
```

### 问题2：按钮位置不准确

#### 症状
程序点击了错误的位置，没有成功加入战斗

#### 排查步骤
1. 查看 `debug_output/orange_button_detected_*.png`
2. 观察红色圆点是否在按钮中心
3. 查看日志中的按钮位置：
   ```
   使用检测到的按钮位置: (xxx, yyy)
   ```

#### 解决方案
手动测量按钮位置并更新：
```python
# 在 click_join_battle() 方法中
button_x = 730  # 根据实际位置调整
button_y = 25   # 根据实际位置调整
```

### 问题3：程序一直等待

#### 症状
程序运行后一直输出 "等待..." 或 "未知状态"

#### 排查步骤
1. 确认游戏窗口在最前面（没有被其他窗口遮挡）
2. 确认游戏分辨率为 1920x1080
3. 检查是否有游戏内弹窗遮挡界面

#### 解决方案
- 关闭所有遮挡游戏的窗口
- 调整游戏分辨率
- 手动关闭游戏内弹窗

## 测试记录表

### 基本信息
- 测试日期：__________
- 游戏版本：__________
- Python版本：__________
- 屏幕分辨率：__________

### 测试结果

| 测试项 | 通过 | 失败 | 备注 |
|--------|------|------|------|
| 调试模式启动 | ☐ | ☐ |  |
| 港口界面识别 | ☐ | ☐ |  |
| 橙色按钮检测 | ☐ | ☐ |  |
| 按钮点击准确性 | ☐ | ☐ |  |
| 战船选择 | ☐ | ☐ |  |
| 成功加入战斗 | ☐ | ☐ |  |
| 战斗中识别 | ☐ | ☐ |  |
| 被击毁识别 | ☐ | ☐ |  |
| 自动退出战斗 | ☐ | ☐ |  |
| 返回港口 | ☐ | ☐ |  |
| 循环游戏 | ☐ | ☐ |  |

## 日志分析要点

### 成功的日志应该包含
```
检测到港口界面（橙色加入战斗按钮）
选择第 1 艘战船
战船位置: (100, 1000)
准备点击加入战斗按钮
检测到橙色加入战斗按钮，位置: (730, 25)
使用检测到的按钮位置: (730, 25)
已点击加入战斗按钮
```

### 失败的日志可能显示
```
未知状态: GameState.UNKNOWN
或
未能检测到按钮，使用默认位置
```

## 调试技巧

### 1. 使用截图对比
拍摄实际游戏界面截图，与 `debug_output/` 中的截图对比，查看程序"看到"的内容。

### 2. 逐步运行
可以在关键位置添加 `input("按回车继续...")` 来暂停程序，逐步观察。

### 3. 调整日志级别
修改日志级别为 DEBUG 以获得更详细信息：
```python
logging.basicConfig(
    level=logging.DEBUG,  # 改为 DEBUG
    ...
)
```

### 4. 颜色检测工具
可以使用 `img/` 目录下的游戏截图，编写小脚本测试颜色检测：
```python
import cv2
import numpy as np

img = cv2.imread('img/6dbb35aad67bf33c816d33c38e1978e1.png')
hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)

# 检测橙色
orange_lower = np.array([10, 100, 100])
orange_upper = np.array([25, 255, 255])
mask = cv2.inRange(hsv, orange_lower, orange_upper)

print(f"橙色像素数: {cv2.countNonZero(mask)}")
cv2.imshow('Mask', mask)
cv2.waitKey(0)
```

## 性能测试

### 测试目标
- 状态检测速度：< 1秒
- 按钮点击响应：< 2秒
- 单局游戏完成：根据实际战斗时间

### 测试方法
观察日志中的时间戳，计算各步骤耗时。

## 测试完成标准

所有以下条件均满足：
- [x] 能够正确识别港口界面
- [x] 能够检测到橙色"加入战斗"按钮
- [x] 能够准确点击按钮
- [x] 成功进入游戏加载界面
- [ ] 能够完整完成一局游戏（需用户实际测试）
- [ ] 能够自动开始下一局（需用户实际测试）

## 反馈

如果测试中发现问题，请记录：
1. 具体问题描述
2. 控制台日志输出
3. `debug_output/` 中的相关截图
4. 游戏界面截图

---

**作者**: seven  
**时间**: 2025-12-23

